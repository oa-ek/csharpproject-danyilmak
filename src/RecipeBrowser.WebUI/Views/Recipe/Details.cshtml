@using RecipeBrowser.Core.Entities
@model Recipe

@{
    bool hasReview = Model.Reviews.Any(r => r.User.Email == User.Identity.Name);
    List<SelectListItem> collections = new List<SelectListItem>();
    collections = ViewBag.Collections as List<SelectListItem>;
}

@if (User.IsInRole("Admin"))
{
    <a class="btn btn-dark my-2" asp-action="">До списку</a>
}
<div class="p-3">
    <h1 class="text-center">@Model.Title</h1>
    <div>
        <p class="my-2">Автор: @Model.Creator.FullName</p>
        <div class="d-flex justify-content-around">
            <img src="@Model.ImagePath" class="rounded" style="max-width: 50vw;" />
            <div class="d-flex flex-column justify-content-evenly p-3 mt-3">
                <div class="d-flex gap-2 border-bottom border-3">
                    <i class="bi bi-alarm"></i>
                    <p>Час приготування: @Model.CookDuration хв.</p>
                </div>
                <div class="d-flex gap-2 border-bottom border-3 mt-3">
                    <i class="bi bi-award"></i>
                    <p>Складність: @Model.Difficulty.Title</p>
                </div>
                <div class="d-flex gap-2 border-bottom border-3 mt-3">
                    <i class="bi bi-book"></i>
                    <p>Спосіб приготування: @Model.Type.Title</p>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <i class="bi bi-star-half"></i>
                    <p>Середня оцінка: @(Model.Reviews.Any() ? Math.Round(Model.Reviews.Average(r => r.Rating), 1) : 0)</p>
                </div>
            </div>
        </div>
    </div>
    <div class="mt-5 p-5">
        <h5 class="text-center">Інгредієнти:</h5>
        <ul>
            @foreach (var ing in Model.Ingredients)
            {
                <li>@ing.Product.Title: @ing.Amount @ing.Measure.Title</li>
            }
        </ul>
    </div>
    <div class="mt-5 p-5">
        <h5 class="text-center">Приготування:</h5>
        <h6 class="">
            @Html.Raw(Model.Description.Replace("\n", "<br />"))
        </h6>
    </div>
    @if (User.IsInRole("Admin") || User.IsInRole("User"))
    {
        <div>
            <form id="add-to-collection-form" asp-controller="RecipeCollection" asp-action="AddRecipeToCollection">
                <input type="hidden" name="recipeId" value="@Model.Id" />
                <div class="d-flex mb-3 justify-content-start align-items-center gap-5">
                    <p>Додати в колекцію</p>
                    <select name="collectionId" asp-items="@(collections)" class="form-control w-50">
                        <option value="0" selected="selected">- Оберіть колекцію -</option>
                    </select>
                    <div class="d-flex gap-2 align-items-center justify-content-center">
                        <button class="btn btn-primary" type="submit">Додати</button>
                    </div>
                </div>
            </form>
        </div>
    }
    <div>
        @if ((User.IsInRole("Admin") || User.IsInRole("User")) && !hasReview)
        {
            <div class="accordion mb-3" id="accordionExample">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            Залишити відгук
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            <form id="review-form" asp-controller="Review" asp-action="CreateUserReview" enctype="multipart/form-data">
                                <div class="container-fluid px-5 py-2">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="recipeId" value="@Model.Id" />
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-center gap-2 align-items-center">
                                            <label>Рейтинг</label>
                                            <input id="Rating" name="rating" readonly class="form-control" type="text" hidden />
                                            <div class="my-rating-4"></div>
                                        </div>
                                    </div>
                                    <div class="form-group mt-2">
                                        <label>Текст відгуку</label>
                                        @Html.TextArea("comment", new { @class = "form-control mt-2", @name = "comment" })
                                    </div>
                                    <div class="d-flex gap-2 align-items-center justify-content-center mt-3">
                                        <button class="btn btn-primary w-25" type="submit">Створити</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        }
        <div>
            @foreach (var review in Model.Reviews)
            {
                <div class="card">
                    <div class="card-header">
                        <h6>Автор: @review.User.FullName</h6>
                    </div>
                    <div class="card-body px-3">
                        <span class="my-rating-4" data-rating="@review.Rating.ToString().Replace(',', '.')"></span>
                        <p class="card-text mt-3">@review.Comment</p>
                    </div>
                    <div class="card-footer text-muted">
                        @(review.CreationTime?.ToString("dd.MM.yyyy HH:mm"))
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<link rel="stylesheet" href="~/css/star-rating-svg.css" />
@section Scripts {
    <script src="~/js/jquery.star-rating-svg.js"></script>

    <script>
        $(function () {
            $(".my-rating-4").starRating({
                totalStars: 5,
                starSize: 30,
                emptyColor: 'lightgray',
                hoverColor: 'salmon',
                activeColor: 'cornflowerblue',
                strokeWidth: 0,
                useGradient: false,
                callback: function (currentRating, $el) {
                    $("#Rating").val(currentRating);
                }
            });

            $("#review-form").submit(function (event) {
                event.preventDefault();
                var form = $(this);
                console.log($("#Rating").attr("value"));
                $.ajax({
                    type: form.attr('method'),
                    url: form.attr('action'),
                    data: form.serialize(),
                    success: function (response) {
                        location.reload();
                    },
                    error: function (response) {
                        alert("An error occurred while submitting the form.");
                    }
                });
            });

            $("#add-to-collection-form").submit(function (event) {
                    event.preventDefault();
                    var form = $(this);
                    $.ajax({
                        type: form.attr('method'),
                        url: form.attr('action'),
                        data: form.serialize(),
                        success: function (response) {
                            if (response.success) {
                                alert(response.message);
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function (response) {
                            alert("An error occurred while deleting the recipe from the collection.");
                        }
                    });
                });
            });
    </script>
}
